name: Build ImmortalWrt-mt798x-6.6 (padavanonly)

on: 
  release:
    types: [published]
  push:
    tags:
    - 'v*'
  watch:
    types: [started]

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    timeout-minutes: 240
    env:
      TARGET_DEVICE: xiaomi_redmi-ax6000
      REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6
      # 核心修复：将分支改为仓库实际的默认分支（优先试mt798x-6.6，其次master）
      REPO_BRANCH: mt798x-6.6
      APT_SOURCE: mirrors.aliyun.com

    steps:
    - name: Optimize System Environment
      run: |
        sudo sed -i "s/archive.ubuntu.com/${APT_SOURCE}/g" /etc/apt/sources.list
        sudo sed -i "s/security.ubuntu.com/${APT_SOURCE}/g" /etc/apt/sources.list
        sudo fallocate -l 8G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        sudo apt update && sudo apt full-upgrade -y --fix-missing
        sudo apt autoremove -y && sudo apt clean

    - name: Install Build Dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt install -y \
        build-essential clang-14 llvm-14 flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
        python3-distutils python3-pip python3-docutils rsync unzip zlib1g-dev \
        file wget curl subversion libelf-dev libffi-dev autopoint libgmp3-dev \
        libmpc-dev libmpfr-dev texinfo patchutils swig xsltproc rename \
        pkg-config automake libtool autopoint device-tree-compiler \
        libudev-dev libusb-1.0-0-dev patchelf chrpath squashfs-tools libconfuse-dev
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        pip3 install ninja --user
        sudo ln -sf /usr/bin/autoconf /usr/bin/confutils
        echo -e "\n=== 验证核心依赖 ==="
        python -c "import docutils; print(f'docutils版本: {docutils.__version__}')"
        clang-14 --version | head -n1
        ninja --version || echo "ninja已安装"
        echo -e "=== 依赖验证完成 ===\n"

    - name: Clone Source Code
      run: |
        # 修复：先克隆仓库（不指定分支），再切换到正确分支
        git clone --depth=1 ${REPO_URL} /opt/immortalwrt
        cd /opt/immortalwrt
        # 尝试切换到指定分支，若失败则自动检测仓库所有分支
        if ! git checkout ${REPO_BRANCH}; then
          echo -e "\n警告：分支 ${REPO_BRANCH} 不存在，列出仓库所有分支："
          git branch -r
          # 自动切换到仓库默认分支（origin/HEAD）
          git checkout $(git rev-parse --abbrev-ref origin/HEAD | sed 's/origin\///')
          REPO_BRANCH=$(git branch --show-current)
          echo -e "已自动切换到仓库默认分支：${REPO_BRANCH}\n"
        fi
        # 更新并安装feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        # 检查设备配置文件
        CONFIG_FILE="configs/targets/mediatek/mt798x/${TARGET_DEVICE}.config"
        if [ ! -f "${CONFIG_FILE}" ]; then
          echo -e "\n错误：设备配置文件 ${CONFIG_FILE} 不存在！"
          echo "该仓库支持的mt798x设备列表："
          ls configs/targets/mediatek/mt798x/
          exit 1
        fi
        echo -e "\n源码拉取完成，当前分支：${REPO_BRANCH}，目标设备：${TARGET_DEVICE}\n"

    - name: Configure Build Parameters
      run: |
        cd /opt/immortalwrt
        cp "configs/targets/mediatek/mt798x/${TARGET_DEVICE}.config" .config
        cat >> .config <<EOF
        CONFIG_PACKAGE_coreutils=y
        CONFIG_PACKAGE_coreutils-base64=y
        CONFIG_PACKAGE_wget=y
        CONFIG_PACKAGE_curl=y
        CONFIG_PACKAGE_kmod-mt7986-firmware=y
        CONFIG_PACKAGE_mt7986-firmware=y
        CONFIG_IPV6=y
        CONFIG_PACKAGE_ip6tables=y
        CONFIG_PACKAGE_odhcp6c=y
        CONFIG_DEBUG_KERNEL=n
        CONFIG_STRIP_KERNEL_EXPORTS=y
        CONFIG_SQUASHFS_COMPRESSION_ZSTD=y
        CONFIG_SQUASHFS_COMPRESSION_LEVEL=15
        CONFIG_PACKAGE_luci-app-ssr-plus=n
        CONFIG_PACKAGE_luci-app-passwall=n
        CONFIG_PACKAGE_luci-app-openclash=n
        CONFIG_PACKAGE_luci-app-ddns-go=y
        CONFIG_PACKAGE_luci-app-samba4=y
        CONFIG_PACKAGE_luci-app-wireguard=y
        EOF
        make defconfig
        echo -e "\n=== 关键编译配置 ==="
        cat .config | grep -E "mt798|TARGET|KERNEL|DEBUG|COMPRESSION"
        echo -e "=== 配置完成 ===\n"

    - name: Build Firmware
      run: |
        cd /opt/immortalwrt
        echo -e "\n=== 开始校验配置（单线程）==="
        make -j1 V=s
        echo -e "\n=== 开始编译固件（多线程）==="
        make -j$(nproc) V=s
        mkdir -p /opt/images
        cp -f bin/targets/mediatek/mt798x/*.bin /opt/images/
        cp -f bin/targets/mediatek/mt798x/*.sha256sum /opt/images/
        [ -f "bin/targets/mediatek/mt798x/README.md" ] && cp -f $_ /opt/images/
        echo -e "\n=== 编译产物列表 ==="
        ls -lh /opt/images/
        echo -e "\n固件编译完成！\n"

    - name: Upload Firmware Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ImmortalWrt-mt798x-6.6-${{ env.TARGET_DEVICE }}-padavanonly
        path: /opt/images
        retention-days: 30
