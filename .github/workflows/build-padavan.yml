name: Build ImmortalWrt-mt798x-6.6 (padavanonly)

on: 
  release:
    types: [published]
  push:
    tags:
    - 'v*'
  watch:
    types: [started]

jobs:
  build:
    runs-on: ubuntu-22.04  # 适配mt798x-6.6内核的最优系统版本
    if: github.event.repository.owner.id == github.event.sender.id
    timeout-minutes: 240    # 延长编译超时（mt798x-6.6编译耗时更长）
    env:
      # 自定义mt798x设备型号（按需修改，参考仓库configs目录）
      TARGET_DEVICE: xiaomi_redmi-ax6000
      # padavanonly仓库地址&分支
      REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6
      REPO_BRANCH: main

    steps:
    - name: 系统环境优化（国内源+交换分区）
      run: |
        # 更换阿里云Ubuntu源，加速依赖下载
        sudo sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list
        sudo sed -i 's/security.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list
        # 添加8GB交换分区，解决mt798x-6.6编译内存不足
        sudo fallocate -l 8G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        # 升级系统基础包
        sudo apt update && sudo apt full-upgrade -y

    - name: 安装mt798x-6.6编译依赖（padavanonly版专属）
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # 基础编译依赖（兼容padavanonly仓库的定制脚本）
        sudo apt install -y build-essential clang-14 llvm-14 flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
        python3-distutils python3-pip python3-docutils rsync unzip zlib1g-dev \
        file wget curl subversion libelf-dev libffi-dev autopoint libgmp3-dev \
        libmpc-dev libmpfr-dev texinfo patchutils swig xsltproc rename \
        pkg-config confutils automake libtool autopoint device-tree-compiler \
        libudev-dev libusb-1.0-0-dev patchelf chrpath squashfs-tools
        # 配置Python3为默认（兼容padavanonly脚本对python的调用）
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        # 安装ninja（mt798x-6.6编译必需）
        pip3 install ninja --user
        # 验证关键依赖
        python -c "import docutils; print('docutils版本:', docutils.__version__)"
        clang-14 --version || echo "clang-14已安装"

    - name: 拉取padavanonly/immortalwrt-mt798x-6.6源码
      run: |
        # 克隆仓库（深度1加快速度）
        git clone --depth=1 --branch $REPO_BRANCH $REPO_URL /opt/immortalwrt
        cd /opt/immortalwrt
        # 更新并安装feeds（padavanonly仓库的定制feeds）
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        # 检查mt798x配置文件是否存在
        if [ ! -f "configs/targets/mediatek/mt798x/${TARGET_DEVICE}.config" ]; then
          echo "错误：设备配置文件 ${TARGET_DEVICE}.config 不存在！"
          echo "可用设备列表："
          ls configs/targets/mediatek/mt798x/
          exit 1
        fi

    - name: 配置mt798x编译参数（适配padavanonly定制版）
      run: |
        cd /opt/immortalwrt
        # 加载目标设备默认配置
        cp configs/targets/mediatek/mt798x/${TARGET_DEVICE}.config .config
        # 自定义配置（padavanonly版专属优化）
        cat >> .config <<EOF
        # 启用Padavan风格的基础工具
        CONFIG_PACKAGE_coreutils=y
        CONFIG_PACKAGE_coreutils-base64=y
        # 启用mt7986硬件加速
        CONFIG_PACKAGE_kmod-mt7986-firmware=y
        CONFIG_PACKAGE_mt7986-firmware=y
        # 启用IPv6（mt798x必备）
        CONFIG_IPV6=y
        CONFIG_PACKAGE_ip6tables=y
        # 关闭调试信息（减小固件体积）
        CONFIG_DEBUG_KERNEL=n
        CONFIG_STRIP_KERNEL_EXPORTS=y
        # 自定义插件（按需开启/关闭）
        CONFIG_PACKAGE_luci-app-ssr-plus=n
        CONFIG_PACKAGE_luci-app-passwall=n
        CONFIG_PACKAGE_luci-app-ddns-go=y
        CONFIG_PACKAGE_luci-app-samba4=y
        EOF
        # 自动补全配置（mt798x-6.6必须执行）
        make defconfig
        # 查看最终配置（调试用）
        cat .config | grep -E "mt798|TARGET|Padavan|KERNEL"

    - name: 编译padavanonly版ImmortalWrt-mt798x-6.6固件
      run: |
        cd /opt/immortalwrt
        # 先单线程校验配置（避免mt798x-6.6配置冲突）
        make -j1 V=s
        # 多线程编译（根据CPU核心数自动分配）
        make -j$(nproc) V=s
        # 创建输出目录
        mkdir -p /opt/images
        # 拷贝编译产物（padavanonly版固件格式为.bin）
        cp -f bin/targets/mediatek/mt798x/*.bin /opt/images/
        cp -f bin/targets/mediatek/mt798x/*.sha256sum /opt/images/
        # 拷贝padavanonly专属的刷机说明
        if [ -f "bin/targets/mediatek/mt798x/README.md" ]; then
          cp -f bin/targets/mediatek/mt798x/README.md /opt/images/
        fi

    - name: 上传编译产物
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ImmortalWrt-mt798x-6.6-${{ env.TARGET_DEVICE }}-padavanonly
        path: /opt/images
        retention-days: 30  # 产物保留30天
