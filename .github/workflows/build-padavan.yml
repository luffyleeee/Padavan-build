name: Build & Release ImmortalWrt-mt7986-AX6000

on: 
  release:
    types: [published]
  push:
    tags:
    - 'v*'  # 推送v开头的tag触发（如v1.0.0）
  workflow_dispatch:  # 手动触发编译

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    timeout-minutes: 300  # 延长超时（8核编译更快，但预留足够时间）
    env:
      REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6
      REPO_BRANCH: openwrt-24.10-6.6
      APT_SOURCE: mirrors.aliyun.com
      CORE_COUNT: 8  # 8核编译

    steps:
    ###########################################################################
    # 1. 深度清理磁盘（释放10GB+空间，支撑8核编译的临时文件）
    ###########################################################################
    - name: Clean Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell
        sudo rm -rf /opt/hostedtoolcache/CodeQL /opt/hostedtoolcache/Python
        sudo apt clean && sudo apt autoremove -y --purge
        sudo rm -rf /var/log/* /tmp/* /var/tmp/*
        echo -e "\n=== 磁盘空间状态 ==="
        df -h
        echo -e "====================\n"

    ###########################################################################
    # 2. 系统环境+依赖安装（适配mt7986+8核编译）
    ###########################################################################
    - name: Install Build Dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # 替换国内源
        sudo sed -i "s/archive.ubuntu.com/${APT_SOURCE}/g" /etc/apt/sources.list
        sudo sed -i "s/security.ubuntu.com/${APT_SOURCE}/g" /etc/apt/sources.list
        # 安装核心依赖（含8核编译必需的多线程库）
        sudo apt update && sudo apt install -y --no-install-recommends \
        build-essential clang-14 llvm-14 flex bison g++ gawk gcc-multilib g++-multilib \
        gettext git libncurses5-dev libssl-dev python3-distutils python3-pip python3-docutils \
        rsync unzip zlib1g-dev file wget curl subversion libelf-dev libffi-dev autopoint \
        libgmp3-dev libmpc-dev libmpfr-dev texinfo patchutils swig xsltproc rename pkg-config \
        automake libtool device-tree-compiler libudev-dev libusb-1.0-0-dev patchelf chrpath \
        squashfs-tools libconfuse-dev libblkid-dev libcap-ng-dev libcbor-dev libevdev-dev \
        libfido2-dev libnl-3-dev libnl-genl-3-dev libnl-nf-3-dev libnl-route-3-dev libpcap-dev \
        libstdc++-11-dev libudev-zero-dev libuuid-dev libatomic1 libncurses6
        # 配置Python3默认
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        pip3 install --no-cache-dir ninja
        sudo ln -sf /usr/bin/autoconf /usr/bin/confutils
        # 清理缓存
        sudo apt clean && sudo rm -rf ~/.cache/pip
        echo -e "\n=== 依赖安装完成，编译核心数：${CORE_COUNT} ==="

    ###########################################################################
    # 3. 拉取源码+加载自定义.config
    ###########################################################################
    - name: Clone Source & Apply Custom Config
      run: |
        # 克隆源码（浅克隆减少空间占用）
        git clone --depth=1 --branch ${REPO_BRANCH} ${REPO_URL} /opt/immortalwrt
        cd /opt/immortalwrt
        # 更新feeds（适配mt7986插件）
        ./scripts/feeds update -a --no-cache
        ./scripts/feeds install -a
        # 删除原有.config，替换为自定义配置
        rm -f .config
        cat > .config << 'EOF'
        CONFIG_TARGET_mediatek=y
        CONFIG_TARGET_mediatek_mt7986=y
        CONFIG_TARGET_MULTI_PROFILE=y
        CONFIG_TARGET_PER_DEVICE_ROOTFS=y
        CONFIG_HAS_SUBTARGETS=y
        CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_glinet_gl-mt6000=y
        CONFIG_TARGET_DEVICE_PACKAGES_mediatek_filogic_DEVICE_glinet_gl-mt6000=""
        CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_jdcloud_re-cp-03=y
        CONFIG_TARGET_DEVICE_PACKAGES_mediatek_filogic_DEVICE_jdcloud_re-cp-03=""
        CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_tplink_tl-xdr6086=y
        CONFIG_TARGET_DEVICE_PACKAGES_mediatek_filogic_DEVICE_tplink_tl-xdr6086=""
        CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_tplink_tl-xdr6088=y
        CONFIG_TARGET_DEVICE_PACKAGES_mediatek_filogic_DEVICE_tplink_tl-xdr6088=""
        CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_xiaomi_redmi-router-ax6000-ubootmod=y
        CONFIG_TARGET_DEVICE_PACKAGES_mediatek_filogic_DEVICE_xiaomi_redmi-router-ax6000-ubootmod=""
        CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_xiaomi_redmi-router-ax6000-stock=y
        CONFIG_TARGET_DEVICE_PACKAGES_mediatek_filogic_DEVICE_xiaomi_redmi-router-ax6000-stock=""
        CONFIG_DEVEL=y
        CONFIG_TOOLCHAINOPTS=y
        CONFIG_BUSYBOX_CUSTOM=y
        CONFIG_AFALG_UPDATE_CTR_IV=y
        CONFIG_BUSYBOX_CONFIG_BLKID=y
        CONFIG_BUSYBOX_CONFIG_FEATURE_BLKID_TYPE=y
        CONFIG_BUSYBOX_CONFIG_VOLUMEID=y
        CONFIG_CONNINFRA_AUTO_UP=y
        CONFIG_CONNINFRA_EMI_SUPPORT=y
        # CONFIG_GDB is not set
        CONFIG_INCLUDE_CONFIG=y
        CONFIG_JSON_OVERVIEW_IMAGE_INFO=y
        # CONFIG_KERNEL_BLK_DEV_THROTTLING is not set
        # CONFIG_KERNEL_CFS_BANDWIDTH is not set
        CONFIG_KERNEL_CGROUP_DEVICE=y
        CONFIG_KERNEL_CGROUP_FREEZER=y
        CONFIG_KERNEL_DEVMEM=y
        # CONFIG_KERNEL_KEYS is not set
        # CONFIG_KERNEL_MEMCG_SWAP is not set
        CONFIG_KERNEL_NET_CLS_CGROUP=y
        CONFIG_MTK_ACK_CTS_TIMEOUT_SUPPORT=y
        CONFIG_MTK_AIR_MONITOR=y
        CONFIG_MTK_AMPDU_CONF_SUPPORT=y
        CONFIG_MTK_ANTENNA_CONTROL_SUPPORT=y
        CONFIG_MTK_APCLI_SUPPORT=y
        CONFIG_MTK_ATE_SUPPORT=y
        CONFIG_MTK_BACKGROUND_SCAN_SUPPORT=y
        CONFIG_MTK_CAL_BIN_FILE_SUPPORT=y
        CONFIG_MTK_CFG_SUPPORT_FALCON_MURU=y
        CONFIG_MTK_CFG_SUPPORT_FALCON_PP=y
        CONFIG_MTK_CFG_SUPPORT_FALCON_SR=y
        CONFIG_MTK_CFG_SUPPORT_FALCON_TXCMD_DBG=y
        CONFIG_MTK_CHIP_MT7986=y
        CONFIG_MTK_CONNINFRA_APSOC=y
        CONFIG_MTK_CONNINFRA_APSOC_MT7986=y
        CONFIG_MTK_CON_WPS_SUPPORT=y
        CONFIG_MTK_DBDC_MODE=y
        CONFIG_MTK_DOT11K_RRM_SUPPORT=y
        CONFIG_MTK_DOT11R_FT_SUPPORT=y
        CONFIG_MTK_DOT11W_PMF_SUPPORT=y
        CONFIG_MTK_DOT11_HE_AX=y
        CONFIG_MTK_DOT11_N_SUPPORT=y
        CONFIG_MTK_DOT11_VHT_AC=y
        CONFIG_MTK_FAST_NAT_SUPPORT=y
        CONFIG_MTK_FIRST_IF_EEPROM_FLASH=y
        CONFIG_MTK_FIRST_IF_IPAILNA=y
        CONFIG_MTK_FIRST_IF_MT7986=y
        CONFIG_MTK_GREENAP_SUPPORT=y
        CONFIG_MTK_G_BAND_256QAM_SUPPORT=y
        CONFIG_MTK_HDR_TRANS_RX_SUPPORT=y
        CONFIG_MTK_HDR_TRANS_TX_SUPPORT=y
        CONFIG_MTK_ICAP_SUPPORT=y
        CONFIG_MTK_IGMP_SNOOP_SUPPORT=y
        CONFIG_MTK_INTERWORKING=y
        CONFIG_MTK_BAND_STEERING=y
        CONFIG_MTK_MAP_SUPPORT=y
        CONFIG_MTK_MAP_R2_VER_SUPPORT=y
        CONFIG_MTK_MAP_R3_VER_SUPPORT=y
        CONFIG_MTK_MAP_R2_6E_SUPPORT=y
        CONFIG_MTK_MAP_R3_6E_SUPPORT=y
        CONFIG_MTK_MBO_SUPPORT=y
        CONFIG_MTK_MBSS_DTIM_SUPPORT=y
        CONFIG_MTK_MBSS_SUPPORT=y
        CONFIG_MTK_MCAST_RATE_SPECIFIC=y
        CONFIG_MTK_MGMT_TXPWR_CTRL=y
        CONFIG_MTK_MLME_MULTI_QUEUE_SUPPORT=y
        CONFIG_MTK_MT7986_NEW_FW=y
        CONFIG_MTK_MT_AP_SUPPORT=m
        CONFIG_MTK_MT_DFS_SUPPORT=y
        CONFIG_MTK_MT_MAC=y
        CONFIG_MTK_MT_WIFI=m
        CONFIG_MTK_MT_WIFI_PATH="mt_wifi"
        CONFIG_MTK_MUMIMO_SUPPORT=y
        CONFIG_MTK_MU_RA_SUPPORT=y
        CONFIG_MTK_OFFCHANNEL_SCAN_FEATURE=y
        CONFIG_MTK_OWE_SUPPORT=y
        CONFIG_MTK_PHY_ICS_SUPPORT=y
        CONFIG_MTK_QOS_R1_SUPPORT=y
        CONFIG_MTK_RA_PHY_RATE_SUPPORT=y
        CONFIG_MTK_RED_SUPPORT=y
        CONFIG_MTK_RTMP_FLASH_SUPPORT=y
        CONFIG_MTK_RT_FIRST_CARD_EEPROM="flash"
        CONFIG_MTK_RT_FIRST_IF_RF_OFFSET=0xc0000
        CONFIG_MTK_SCS_FW_OFFLOAD=y
        CONFIG_MTK_SECOND_IF_NONE=y
        CONFIG_MTK_SMART_CARRIER_SENSE_SUPPORT=y
        CONFIG_MTK_SPECTRUM_SUPPORT=y
        CONFIG_MTK_SUPPORT_OPENWRT=y
        CONFIG_MTK_THERMAL_PROTECT_SUPPORT=y
        CONFIG_MTK_THIRD_IF_NONE=y
        CONFIG_MTK_TPC_SUPPORT=y
        CONFIG_MTK_TXBF_SUPPORT=y
        CONFIG_MTK_UAPSD=y
        CONFIG_MTK_VLAN_SUPPORT=y
        CONFIG_MTK_VOW_SUPPORT=y
        CONFIG_MTK_WARP_V2=y
        CONFIG_MTK_WDS_SUPPORT=y
        CONFIG_MTK_WHNAT_SUPPORT=m
        CONFIG_MTK_WIFI_ADIE_TYPE="mt7976"
        CONFIG_MTK_WIFI_BASIC_FUNC=y
        CONFIG_MTK_WIFI_DRIVER=y
        CONFIG_MTK_WIFI_EAP_FEATURE=y
        CONFIG_MTK_WIFI_FW_BIN_LOAD=y
        CONFIG_MTK_WIFI_MODE_AP=m
        CONFIG_MTK_WIFI_MT_MAC=y
        CONFIG_MTK_WIFI_SKU_TYPE="AX6000"
        CONFIG_MTK_WIFI_TWT_SUPPORT=y
        CONFIG_MTK_WLAN_HOOK=y
        CONFIG_MTK_WLAN_SERVICE=y
        CONFIG_MTK_WNM_SUPPORT=y
        CONFIG_MTK_WPA3_SUPPORT=y
        CONFIG_MTK_WSC_INCLUDED=y
        CONFIG_MTK_WSC_V2_SUPPORT=y
        # CONFIG_OPENSSL_ENGINE_BUILTIN is not set
        # CONFIG_OPENSSL_PREFER_CHACHA_OVER_GCM is not set
        CONFIG_OPENSSL_WITH_NPN=y
        # CONFIG_PACKAGE_TURBOACC_INCLUDE_FLOW_OFFLOADING is not set
        CONFIG_PACKAGE_TURBOACC_INCLUDE_NO_FASTPATH=y
        CONFIG_PACKAGE_blockd=y
        CONFIG_PACKAGE_ca-certificates=y
        CONFIG_PACKAGE_datconf=y
        CONFIG_PACKAGE_datconf-lua=y
        CONFIG_PACKAGE_ethtool=y
        CONFIG_PACKAGE_ebtables=y
        CONFIG_PACKAGE_htop=y
        CONFIG_PACKAGE_ip-bridge=y
        CONFIG_PACKAGE_ip6tables-extra=y
        CONFIG_PACKAGE_ip6tables-nft=y
        CONFIG_PACKAGE_ipset=y
        CONFIG_PACKAGE_iptables-mod-conntrack-extra=y
        CONFIG_PACKAGE_iptables-mod-extra=y
        CONFIG_PACKAGE_iptables-mod-filter=y
        CONFIG_PACKAGE_iptables-mod-hashlimit=y
        CONFIG_PACKAGE_iptables-mod-iface=y
        CONFIG_PACKAGE_iptables-mod-ipmark=y
        CONFIG_PACKAGE_iptables-mod-ipopt=y
        CONFIG_PACKAGE_iptables-mod-iprange=y
        CONFIG_PACKAGE_iptables-mod-ipv4options=y
        CONFIG_PACKAGE_iptables-mod-nat-extra=y
        CONFIG_PACKAGE_iptables-mod-proto=y
        CONFIG_PACKAGE_iptables-mod-tee=y
        CONFIG_PACKAGE_iptables-mod-tproxy=y
        CONFIG_PACKAGE_iptables-mod-u32=y
        CONFIG_PACKAGE_iw=y
        CONFIG_PACKAGE_iwinfo=y
        CONFIG_PACKAGE_kmod-ata-core=y
        CONFIG_PACKAGE_kmod-conninfra=y
        CONFIG_PACKAGE_kmod-crypto-acompress=y
        CONFIG_PACKAGE_kmod-crypto-ccm=y
        CONFIG_PACKAGE_kmod-crypto-cmac=y
        CONFIG_PACKAGE_kmod-crypto-crc32c=y
        CONFIG_PACKAGE_kmod-crypto-ctr=y
        CONFIG_PACKAGE_kmod-crypto-des=y
        CONFIG_PACKAGE_kmod-crypto-gcm=y
        CONFIG_PACKAGE_kmod-crypto-gf128=y
        CONFIG_PACKAGE_kmod-crypto-ghash=y
        CONFIG_PACKAGE_kmod-crypto-hmac=y
        CONFIG_PACKAGE_kmod-crypto-md4=y
        CONFIG_PACKAGE_kmod-crypto-md5=y
        CONFIG_PACKAGE_kmod-crypto-rng=y
        CONFIG_PACKAGE_kmod-crypto-seqiv=y
        CONFIG_PACKAGE_kmod-crypto-sha256=y
        CONFIG_PACKAGE_kmod-crypto-sha512=y
        CONFIG_PACKAGE_kmod-ebtables=y
        CONFIG_PACKAGE_kmod-ebtables-ipv4=y
        CONFIG_PACKAGE_kmod-ebtables-ipv6=y
        CONFIG_PACKAGE_kmod-fs-autofs4=y
        CONFIG_PACKAGE_kmod-fs-vfat=y
        CONFIG_PACKAGE_kmod-inet-diag=y
        CONFIG_PACKAGE_kmod-ip6tables-extra=y
        CONFIG_PACKAGE_kmod-ipt-compat-xtables=y
        CONFIG_PACKAGE_kmod-ipt-conntrack-extra=y
        CONFIG_PACKAGE_kmod-ipt-extra=y
        CONFIG_PACKAGE_kmod-ipt-filter=y
        CONFIG_PACKAGE_kmod-ipt-hashlimit=y
        CONFIG_PACKAGE_kmod-ipt-iface=y
        CONFIG_PACKAGE_kmod-ipt-ipmark=y
        CONFIG_PACKAGE_kmod-ipt-ipopt=y
        CONFIG_PACKAGE_kmod-ipt-iprange=y
        CONFIG_PACKAGE_kmod-ipt-ipv4options=y
        CONFIG_PACKAGE_kmod-ipt-nat-extra=y
        CONFIG_PACKAGE_kmod-ipt-offload=y
        CONFIG_PACKAGE_kmod-ipt-proto=y
        CONFIG_PACKAGE_kmod-ipt-raw6=y
        CONFIG_PACKAGE_kmod-ipt-tee=y
        CONFIG_PACKAGE_kmod-ipt-tproxy=y
        CONFIG_PACKAGE_kmod-ipt-u32=y
        CONFIG_PACKAGE_kmod-leds-ws2812b=y
        CONFIG_PACKAGE_kmod-lib-crc32c=y
        CONFIG_PACKAGE_kmod-lib-lzo=y
        CONFIG_PACKAGE_kmod-mediatek_hnat=y
        CONFIG_PACKAGE_kmod-mt_wifi=y
        CONFIG_PACKAGE_kmod-nf-flow=y
        CONFIG_PACKAGE_kmod-nls-base=y
        CONFIG_PACKAGE_kmod-nls-cp437=y
        CONFIG_PACKAGE_kmod-nls-iso8859-1=y
        CONFIG_PACKAGE_kmod-nls-utf8=y
        CONFIG_PACKAGE_kmod-scsi-core=y
        CONFIG_PACKAGE_kmod-tcp-bbr=y
        CONFIG_PACKAGE_kmod-tun=y
        CONFIG_PACKAGE_kmod-warp=y
        CONFIG_PACKAGE_kmod-zram=y
        CONFIG_PACKAGE_kvcedit=y
        CONFIG_PACKAGE_libatomic=y
        CONFIG_PACKAGE_libblkid=y
        CONFIG_PACKAGE_libcap-ng=y
        CONFIG_PACKAGE_libcbor=y
        CONFIG_PACKAGE_libevdev=y
        CONFIG_PACKAGE_libfido2=y
        CONFIG_PACKAGE_libipset=y
        CONFIG_PACKAGE_libkvcutil=y
        CONFIG_PACKAGE_libncurses=y
        CONFIG_PACKAGE_libnl=y
        CONFIG_PACKAGE_libnl-core=y
        CONFIG_PACKAGE_libnl-genl=y
        CONFIG_PACKAGE_libnl-nf=y
        CONFIG_PACKAGE_libnl-route=y
        CONFIG_PACKAGE_libopenssl-afalg_sync=y
        CONFIG_PACKAGE_libopenssl-devcrypto=y
        CONFIG_PACKAGE_libpcap=y
        CONFIG_PACKAGE_libstdcpp=y
        CONFIG_PACKAGE_libudev-zero=y
        CONFIG_PACKAGE_libuuid=y
        CONFIG_PACKAGE_luci-app-eqos-mtk=y
        CONFIG_PACKAGE_luci-app-mtwifi-cfg=y
        CONFIG_PACKAGE_lua-cjson=y
        # CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Haproxy is not set
        # CONFIG_PACKAGE_luci-app-passwall_INCLUDE_ShadowsocksR_Libev_Client is not set
        # CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Client is not set
        # CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Libev_Server is not set
        # CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Shadowsocks_Rust_Client is not set
        # CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Simple_Obfs is not set
        # CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Trojan_Plus is not set
        # CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray is not set
        # CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray_Plugin is not set
        # CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray is not set
        # CONFIG_PACKAGE_luci-app-rclone_INCLUDE_rclone-ng is not set
        # CONFIG_PACKAGE_luci-app-rclone_INCLUDE_rclone-webui is not set
        # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ChinaDNS_NG is not set
        CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_NONE_V2RAY=y
        CONFIG_PACKAGE_wifi-scripts=y
        # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_ShadowsocksR_Libev_Client is not set
        CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_NONE_Client=y
        CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_NONE_Server=y
        # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Rust_Client is not set
        # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Rust_Server is not set
        # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Simple_Obfs is not set
        # CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Xray is not set
        CONFIG_PACKAGE_luci-app-turboacc-mtk=y
        CONFIG_PACKAGE_luci-app-wrtbwmon=y
        # CONFIG_PACKAGE_luci-app-vssr_INCLUDE_ShadowsocksR_Libev_Server is not set
        # CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Trojan is not set
        # CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Xray is not set
        # CONFIG_PACKAGE_luci-app-vssr_INCLUDE_Xray_plugin is not set
        CONFIG_PACKAGE_luci-i18n-mtwifi-cfg-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-turboacc-mtk-zh-cn=y 
        CONFIG_PACKAGE_luci-theme-bootstrap-mod=y
        CONFIG_PACKAGE_mii_mgr=y 
        CONFIG_PACKAGE_mtkhqos_util=y
        CONFIG_PACKAGE_mtk-smp=y
        CONFIG_PACKAGE_nano=y
        CONFIG_PACKAGE_openssh-keygen=y
        CONFIG_PACKAGE_openssh-sftp-server=y
        CONFIG_PACKAGE_openssl-util=y
        CONFIG_PACKAGE_regs=y
        CONFIG_PACKAGE_resolveip=y
        # CONFIG_PACKAGE_swconfig is not set
        CONFIG_PACKAGE_switch=y
        CONFIG_PACKAGE_tcpdump=y
        CONFIG_PACKAGE_terminfo=y
        CONFIG_PACKAGE_wifi-dats=y
        CONFIG_PACKAGE_mtwifi-cfg=y
        CONFIG_PACKAGE_wireless-regdb=y
        CONFIG_PACKAGE_wireless-tools=y
        CONFIG_PACKAGE_zram-swap=y
        # CONFIG_PKG_CHECK_FORMAT_SECURITY is not set
        # CONFIG_PKG_FORTIFY_SOURCE_1 is not set
        CONFIG_PKG_FORTIFY_SOURCE_2=y
        CONFIG_WARP_CHIPSET="mt7986"
        CONFIG_WARP_DBG_SUPPORT=y
        CONFIG_WARP_MEMORY_LEAK_DBG=y
        CONFIG_WARP_NEW_FW=y
        CONFIG_WARP_VERSION=2
        CONFIG_WED_HW_RRO_SUPPORT=y
        # CONFIG_WOLFSSL_HAS_ECC25519 is not set
        CONFIG_first_card=y
        CONFIG_first_card_name="MT7986"
        # CONFIG_AFALG_FALLBACK is not set
        # CONFIG_MTK_BAND_STEERING is not set
        # CONFIG_MTK_DEFAULT_5G_PROFILE is not set
        # CONFIG_MTK_MAC_REPEATER_SUPPORT is not set
        # CONFIG_MTK_MULTI_PROFILE_SUPPORT is not set
        # CONFIG_MTK_PCIE_ASPM_DYM_CTRL_SUPPORT is not set
        # CONFIG_MTK_PRE_CAL_TRX_SET1_SUPPORT is not set
        # CONFIG_MTK_PRE_CAL_TRX_SET2_SUPPORT is not set
        # CONFIG_MTK_RLM_CAL_CACHE_SUPPORT is not set
        # CONFIG_MTK_SNIFFER_RADIOTAP_SUPPORT is not set
        EOF
        # 自动补全配置依赖（关键：解决mt7986驱动依赖缺失）
        make defconfig
        # 清理.git目录节省空间
        rm -rf .git feeds/.git
        echo -e "\n=== 自定义.config已加载 ==="

    ###########################################################################
    # 4. 8核编译固件（关键：-j${CORE_COUNT}）
    ###########################################################################
    - name: Build Firmware (8 Core)
      run: |
        cd /opt/immortalwrt
        # 添加16G交换分区（8核编译内存需求更高）
        sudo fallocate -l 16G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        # 单线程校验配置（避免8核编译配置冲突）
        echo -e "\n=== 校验配置 ==="
        make -j1 V=s 2>&1 | tee config_check.log
        # 8核并行编译（核心优化）
        echo -e "\n=== 8核编译mt7986-AX6000固件 ==="
        make -j${CORE_COUNT} V=s 2>&1 | tee build.log
        # 整理产物
        mkdir -p /opt/images
        # 拷贝所有固件+校验文件+日志
        cp -f bin/targets/mediatek/mt798x/*.bin /opt/images/
        cp -f bin/targets/mediatek/mt798x/*.sha256sum /opt/images/
        cp -f config_check.log build.log /opt/images/
        # 压缩产物（方便上传Release）
        cd /opt/images
        zip -r ImmortalWrt-mt7986-AX6000-$(date +%Y%m%d).zip ./*
        # 查看产物
        echo -e "\n=== 编译产物 ==="
        ls -lh /opt/images/
        df -h

    ###########################################################################
    # 5. 创建Release并上传编译文件
    ###########################################################################
    - name: Create Release & Upload Assets
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')  # 仅推送tag时创建Release
      with:
        # Release名称（含版本+日期）
        name: ImmortalWrt-mt7986-AX6000-${{ github.ref_name }}-${{ github.run_id }}
        # Release描述
        body: |
          ## mt7986-AX6000 固件编译产物
          - 编译核心数：8核
          - 源码分支：openwrt-24.10-6.6
          - 编译时间：${{ github.run_at }}
          - 适配设备：红米AX6000（mt7986）
          ## 包含文件
          - .bin 刷机固件
          - .sha256sum 校验文件
          - build.log 编译日志
        # 上传的产物（压缩包+原始固件）
        files: |
          /opt/images/*.zip
          /opt/images/*.bin
          /opt/images/*.sha256sum
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub自动生成的令牌，无需手动配置
