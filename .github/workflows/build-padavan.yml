name: Build ImmortalWrt-mt798x-6.6 (padavanonly)

on: 
  release:
    types: [published]
  push:
    tags:
    - 'v*'
  watch:
    types: [started]

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    timeout-minutes: 240
    env:
      # 设备配置文件名（精准匹配仓库）
      TARGET_CONFIG: mt7986-ax6000.config
      # 仓库地址&正确分支
      REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6
      REPO_BRANCH: openwrt-24.10-6.6
      # 国内源加速
      APT_SOURCE: mirrors.aliyun.com

    steps:
    ###########################################################################
    # 步骤1：系统环境优化（国内源+8G交换分区）
    ###########################################################################
    - name: Optimize System Environment
      run: |
        # 替换阿里云源
        sudo sed -i "s/archive.ubuntu.com/${APT_SOURCE}/g" /etc/apt/sources.list
        sudo sed -i "s/security.ubuntu.com/${APT_SOURCE}/g" /etc/apt/sources.list
        # 添加8GB交换分区（解决mt798x-6.6编译OOM）
        sudo fallocate -l 8G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        # 系统升级+清理
        sudo apt update && sudo apt full-upgrade -y --fix-missing
        sudo apt autoremove -y && sudo apt clean

    ###########################################################################
    # 步骤2：安装编译依赖（修复confutils/python-docutils）
    ###########################################################################
    - name: Install Build Dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # 核心依赖（移除confutils，补充libconfuse-dev）
        sudo apt install -y \
        build-essential clang-14 llvm-14 flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
        python3-distutils python3-pip python3-docutils rsync unzip zlib1g-dev \
        file wget curl subversion libelf-dev libffi-dev autopoint libgmp3-dev \
        libmpc-dev libmpfr-dev texinfo patchutils swig xsltproc rename \
        pkg-config automake libtool autopoint device-tree-compiler \
        libudev-dev libusb-1.0-0-dev patchelf chrpath squashfs-tools libconfuse-dev
        # 配置Python3为默认
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        # 安装ninja（mt798x-6.6必需）
        pip3 install ninja --user
        # 兼容confutils调用
        sudo ln -sf /usr/bin/autoconf /usr/bin/confutils
        # 验证依赖
        echo -e "\n=== 核心依赖验证 ==="
        python -c "import docutils; print(f'docutils版本: {docutils.__version__}')"
        clang-14 --version | head -n1
        ninja --version || echo "ninja已安装"
        echo -e "=== 依赖验证完成 ===\n"

    ###########################################################################
    # 步骤3：拉取源码+验证配置文件
    ###########################################################################
    - name: Clone Source Code & Verify Config
      run: |
        # 克隆指定分支的源码
        git clone --depth=1 --branch ${REPO_BRANCH} ${REPO_URL} /opt/immortalwrt
        cd /opt/immortalwrt
        # 更新feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a

        # 验证配置文件是否存在（精准指向defconfig目录）
        CONFIG_FILE="defconfig/${TARGET_CONFIG}"
        if [ ! -f "${CONFIG_FILE}" ]; then
          echo -e "\n错误：配置文件 ${CONFIG_FILE} 不存在！"
          echo "defconfig目录下所有配置文件："
          ls -l defconfig/*.config
          exit 1
        fi
        echo -e "\n✅ 找到配置文件：${CONFIG_FILE}"
        # 复制配置文件到编译根目录
        cp ${CONFIG_FILE} .config

    ###########################################################################
    # 步骤4：自定义编译参数（适配AX6000）
    ###########################################################################
    - name: Customize Build Config
      run: |
        cd /opt/immortalwrt
        # 追加自定义配置（AX6000专属优化）
        cat >> .config <<EOF
        # AX6000硬件适配
        CONFIG_PACKAGE_kmod-mt7986-firmware=y
        CONFIG_PACKAGE_mt7986-firmware=y
        CONFIG_PACKAGE_mt7986-ax6000-firmware=y
        # 基础功能
        CONFIG_PACKAGE_coreutils=y
        CONFIG_PACKAGE_wget=y
        CONFIG_PACKAGE_curl=y
        # IPv6支持
        CONFIG_IPV6=y
        CONFIG_PACKAGE_ip6tables=y
        CONFIG_PACKAGE_odhcp6c=y
        # 固件优化
        CONFIG_DEBUG_KERNEL=n
        CONFIG_STRIP_KERNEL_EXPORTS=y
        CONFIG_SQUASHFS_COMPRESSION_ZSTD=y
        CONFIG_SQUASHFS_COMPRESSION_LEVEL=15
        # 常用插件（按需调整y/n）
        CONFIG_PACKAGE_luci-app-ssr-plus=n
        CONFIG_PACKAGE_luci-app-passwall=n
        CONFIG_PACKAGE_luci-app-ddns-go=y
        CONFIG_PACKAGE_luci-app-samba4=y
        CONFIG_PACKAGE_luci-app-wireguard=y
        EOF
        # 自动补全配置依赖
        make defconfig
        # 打印关键配置
        echo -e "\n=== AX6000编译配置 ==="
        cat .config | grep -E "mt7986|AX6000|KERNEL|COMPRESSION"
        echo -e "=== 配置完成 ===\n"

    ###########################################################################
    # 步骤5：编译固件（AX6000专属）
    ###########################################################################
    - name: Build AX6000 Firmware
      run: |
        cd /opt/immortalwrt
        # 1. 单线程校验配置（避免多线程冲突）
        echo -e "\n=== 校验配置（单线程）==="
        make -j1 V=s
        # 2. 多线程编译（最大化利用CPU）
        echo -e "\n=== 编译AX6000固件（多线程）==="
        make -j$(nproc) V=s
        # 3. 整理产物
        mkdir -p /opt/images
        # 拷贝所有mt7986-AX6000相关固件
        cp -f bin/targets/mediatek/mt798x/*.bin /opt/images/
        cp -f bin/targets/mediatek/mt798x/*.sha256sum /opt/images/
        # 拷贝刷机说明
        [ -f "bin/targets/mediatek/mt798x/README.md" ] && cp -f $_ /opt/images/
        # 打印产物列表
        echo -e "\n=== 编译产物 ==="
        ls -lh /opt/images/
        echo -e "\n✅ AX6000固件编译完成！\n"

    ###########################################################################
    # 步骤6：上传产物（失败也保留）
    ###########################################################################
    - name: Upload Firmware Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ImmortalWrt-mt7986-AX6000-${{ env.REPO_BRANCH }}
        path: /opt/images
        retention-days: 30
